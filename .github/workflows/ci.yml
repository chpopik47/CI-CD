permissions:
  contents: read
  packages: write

name: CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - run: pip install -r requirements.txt
      - run: pip install ruff

      - run: ruff check .
      - run: pytest

  docker-smoke:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Build image
        run: docker build -t clinic-api:ci .

      - name: Run container
        run: docker run -d -p 8000:8000 --name clinic-api clinic-api:ci

      - name: Wait
        run: sleep 2

      - name: Healthcheck
        run: curl -f http://127.0.0.1:8000/health

      - name: Logs on failure
        if: failure()
        run: docker logs clinic-api

      - name: Cleanup
        if: always()
        run: docker rm -f clinic-api

    publish-image:
    runs-on: ubuntu-latest
    needs: docker-smoke
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set image name
        run: echo "IMAGE=ghcr.io/${GITHUB_REPOSITORY,,}/clinic-api" >> $GITHUB_ENV

      - name: Log in to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build image
        run: docker build -t $IMAGE:${{ github.sha }} -t $IMAGE:latest .

      - name: Push image
        run: |
          docker push $IMAGE:${{ github.sha }}
          docker push $IMAGE:latest
